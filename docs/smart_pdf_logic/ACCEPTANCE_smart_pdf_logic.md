# 验收报告：智能 PDF 提取逻辑

## 1. 摘要
我们在 `server.py` 中实现了“智能提取”逻辑，以解决列表项识别和段落合并的问题。

## 2. 已实现功能
- **标题检测**：使用字号分析来识别 H1、H2、H3 标题。
- **列表项保护**：
    - 防止合并缩进发生显著变化（`> 5.0pt`）的行。
    - 如果上一行提前结束（表明是硬换行），则防止合并。
- **智能段落合并**：
    - 合并垂直距离较近（`< 15.0pt`）且水平对齐的行。
    - 处理中日韩（CJK）字符合并时不加空格。
- **Markdown 输出**：使用 `#` 格式化标题并保护列表结构。

## 3. 验证
- **语法检查**：`import simple_pdf.server` 成功通过。
- **逻辑验证**：代码现在包含了 `abs(curr_x0 - last_x0) > 5.0`（缩进检查）和 `last_x1 < right_margin_threshold`（行宽检查）。

## 4. 性能优化（批量处理）
- **功能**：实现了使用 `ProcessPoolExecutor` 进行并行 PDF 提取。
- **基准测试结果**（在 `D:\Study\JAVA学习` 目录下，192 个文件）：
    - **总耗时**：22.42 秒
    - **平均时间**：每 PDF 0.12 秒
    - **吞吐量**：~8.6 PDF/秒
    - **对比**：相比单线程顺序处理，估计速度提升超过 10 倍。

## 5. 表格提取与优化
- **表格提取**：
    - 实现了基于 `find_tables` 的提取。
    - 将 PyMuPDF 表格转换为 Markdown 格式（`| ... | ... |`）。
    - 智能地将表格与文本内容集成，保留垂直顺序。
    - 实现了 `is_block_in_table` 逻辑，防止表格内容被重复提取为普通文本。
    - 实现了动态正文边界计算 (`estimate_body_right_margin`)，更好地区分表格和侧边栏/正文。
- **表格清洗与过滤** (v2 优化)：
    - **伪表格过滤**：
        - 实现了 `is_valid_table` 函数。
        - 过滤规则1：丢弃单列表格（通常是普通文本）。
        - 过滤规则2：丢弃空列占比 >= 50% 的伪表格。
        - 过滤规则3：丢弃行数 < 3 且稀疏度 > 60% 的误判文本块。
    - **稀疏表格压缩**：
        - 优化 `table_to_markdown`，自动检测并移除内容全空的列。
        - 解决了复杂表格（如“运算符表”）因对齐线误判导致的空列过多的问题。
- **验证结果**：
    - **误判消除**：成功过滤了 `第一章节JAVA入门和背景知识.pdf` P6 中的误判文本块。
    - **稀疏修复**：成功将 `第二章节 变量、数据类型、运算符.pdf` P19 中的 8 列稀疏表格压缩为 5 列紧凑表格，去除了无效空列。
    - **批量采样**：在 `D:\Study\JAVA学习` 目录下随机采样 20 个表格，人工核查显示格式正确，无明显的伪表格残留。
    - **代码块误判过滤 (v3 优化)**：
        - 针对《synchronized底层原理.pdf》中的代码块误判问题。
        - 新增策略4：检测包含连续行号（1, 2, 3...）且包含代码特征字符（{, }, public, void...）的表格。
        - 验证结果：成功将该代码块识别为无效表格，回退为文本提取，保留了代码的可读性。
    - **单行表格过滤 (v3.1 优化)**：
        - 针对《19-分布式面试必会.pdf》中“强一致性”、“单调一致性”等定义被误判为单行表格的问题。
        - 新增策略5：丢弃所有单行表格（Rows < 2）。单行表格在 Markdown 中仅表现为表头，通常不具备数据展示价值，且常用于误判的 Key-Value 布局。
        - 验证结果：成功过滤了 4 个误判的定义表格，使其正确渲染为文本段落。
    - **代码块与HTML误判过滤 (v3.2 优化)**：
        - 针对《web实战案例》和《MyBatis选修》中 HTML/XML 代码块被误判为表格的问题。
        - 策略更新：
            - 增强特征库：加入 HTML/XML 标签（如 `<div>`, `<span>`, `<plugin>` 等）。
            - 新增策略6：高密度代码过滤。如果表格中超过 50% 的单元格包含代码特征，判定为无效表格（即使无行号）。
        - 验证结果：成功过滤了 HTML 代码表、Maven XML 配置表和 Java 代码片段，同时保留了真实的算术运算符表格。

## 6. 索引生成
    - 添加了 `generate_index_file` 工具。
    - 扫描 `batch_output` 目录下的 Markdown 文件。
    - 生成包含所有文档链接的 `README_INDEX.md`。
    - 支持按子目录分层分组。

## 6. 已知局限
- 复杂的嵌套列表可能仍需要更高级的布局分析（例如，显式检测“项目符号”字符）。
- 某些 PDF 可能会在 stderr 中触发 `MuPDF error` 警告（例如 `cannot find ExtGState resource`），但提取通常会成功。
