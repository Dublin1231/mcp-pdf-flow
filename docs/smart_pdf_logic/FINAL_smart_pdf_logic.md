# 最终报告：智能 PDF 提取逻辑

## 项目总结
我们成功升级了 `simple-pdf-extractor` 以处理包括标题和列表项在内的复杂 PDF 结构。关键改进是“智能合并”逻辑，该逻辑尊重视觉布局提示（缩进和行宽）以保留文档结构。

## 交付物
1.  **修改后的 `src/simple_pdf/server.py`**:
    - 添加了 `estimate_body_size` 用于动态字体分析。
    - 在合并循环中添加了 `Line Width Check` (行宽检查) 和 `Indentation Check` (缩进检查)。
    - 添加了 Markdown 格式支持。
2.  **文档**:
    - `docs/smart_pdf_logic/` 中的 `ALIGNMENT`, `DESIGN`, `TASK`, `ACCEPTANCE` 文档。
    - 更新了 `README.md`，增加了 `format` 参数说明。

## 技术细节
- **列表项检测**: 使用相对缩进 (`curr_x0` vs `last_x0`)。
- **段落边界**: 使用动态计算的 "正文右边界" (`estimate_body_right_margin`) 检测硬换行，适应不同页边距。
- **字体分析**: 使用 `Counter` 查找最频繁的字体大小作为“正文”基准。
- **表格处理**:
    - **混合内容分离**: 通过 `is_block_in_table` (60% 面积重叠阈值) 确保表格内容不被重复提取。
    - **智能清洗**: 自动移除全空列，压缩稀疏表格；通过行列特征过滤伪表格（误判的文本块）、误判的代码块（带行号）以及 HTML/XML 片段（高密度代码特征）。
    - **长文本与错位布局过滤**: 识别并过滤包含长段落文本的“伪表格”以及因文本换行导致的错位多列表格。
    - **表头合并与空行清洗**: 智能识别被拆分的表头（如"基本\n工资"）进行合并（含数据行安全检查），并自动移除表格中的空行。

## 结论
提取器现在能够从 PDF 生成高质量的 Markdown，正确处理：
1. **列表结构**：识别缩进和硬换行。
2. **表格数据**：自动检测、过滤伪表格、清洗稀疏表格、合并拆分表头、移除空行，并与正文文本正确穿插。
3. **复杂布局**：适应侧边栏、代码块和不同页边距。
经批量验证，提取准确率显著提升，有效解决了“伪表格”、“稀疏表格”、“代码块误判”、“表头拆分”及“空行残留”问题。
