# 设计文档：智能 PDF 提取逻辑

## 1. 架构概览
解决方案将在 `src/simple_pdf/server.py` 中实现。我们将重构 `extract_content` 函数，使用辅助逻辑（智能处理）代替原始的 `page.get_text()`。

## 2. 组件设计

### 2.1 `PDFStructureParser` (逻辑组件)
负责以下功能的一组函数：
1.  **字体分析**: 识别主导字体大小（正文文本）。
2.  **布局分析**: 识别页面边距和文本边界。
3.  **内容提取**: 遍历文本块以构建结构化的 Markdown 表示。

### 2.2 核心逻辑流程
```mermaid
graph TD
    A[开始页面] --> B[获取文本块 (dict)]
    B --> C[分析字体 (查找正文大小)]
    C --> D[分析边距 (查找正文缩进)]
    D --> E[遍历块]
    E --> F{块分析}
    F -->|字体 > 正文 + 2| G[标记为标题]
    F -->|缩进 > 正文 + 阈值| H[标记为列表项]
    F -->|其他| I[标记为正文文本]
    G --> J[合并/格式化]
    H --> J
    I --> J
    J --> K[检查行宽]
    K -->|提前结束| L[插入换行]
    K -->|全宽| M[与下一行合并]
```

## 3. 详细算法

### 3.1 字体大小分析
- 遍历页面中的所有 span。
- 统计 `(font_name, font_size)` 的频率。
- 最频繁的字体大小即为 `BODY_FONT_SIZE`。

### 3.2 缩进与列表检测
- **基准缩进**: 最频繁文本块的 `x0`。
- **列表项**: 如果 `line.bbox.x0 > Base Indent + 5` (容差)。
    - 输出: 如果没有，添加 `- ` 前缀。
    - 处理多行列表项: 如果下一行具有相同的缩进，则是延续 *除非* 上一行提前结束。

### 3.3 智能合并 ("行宽" 检查)
- **目标**: 防止将 "列表项 1" 合并到 "列表项 2" 或将 "标题" 合并到 "正文"。
- **逻辑**:
    - `Page Width` = `page.rect.width`.
    - `Right Margin Threshold` = `Page Width * 0.9` (或 `Page Width - 50`)。
    - 如果 `Current Line.x1 < Right Margin Threshold`:
        - 这是一个 **短行**。
        - 动作: 追加 `\n` (硬回车)。
    - 否则:
        - 这是一个 **满行**。
        - 动作: 追加 ` ` (空格) *如果* 下一行是相同类型。

### 3.4 处理 "JDBC..." 案例
- 用户指出 "JDBC..." 是缩进的。
- 我们的逻辑:
    - 检测缩进 -> 标记为列表。
    - 检测短行 (如果是简短描述) -> 换行。
    - 结果: 正确分隔的列表项。

## 4. 数据结构
- 我们将处理来自 `page.get_text("dict")` 的 `blocks`。
- 结构: `Block -> Lines -> Spans`。

## 5. 接口
- 输入: `fitz.Page`
- 输出: `str` (Markdown 格式文本)
